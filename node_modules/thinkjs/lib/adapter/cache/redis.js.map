{"version":3,"sources":["../../../src/adapter/cache/redis.js"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,IAAI,cAAc,MAAM,OAAN,CAAc,QAAd,EAAwB,OAAxB,CAAlB;;;;;;;;;;;;;;;;;;;;mBAWE,I,iBAAK,O,EAAQ;AACX,SAAK,OAAL,GAAe,MAAM,WAAN,CAAkB,MAAM,MAAN,CAAa,OAAb,CAAlB,EAAyC,OAAzC,CAAf;AACA,SAAK,OAAL,GAAe,KAAK,OAAL,CAAa,OAAb,IAAwB,CAAvC;AACA,SAAK,MAAL,GAAc,KAAK,OAAL,CAAa,MAAb,IAAuB,EAArC;AACD,G;;;;;;;mBAKD,gB,6BAAiB,I,EAAK;AACpB,QAAI,UAAU,MAAM,WAAN,CAAkB,IAAlB,CAAuB,KAAK,OAA5B,EAAqC,MAAM,MAAN,CAAa,OAAb,CAArC,EAA4D;AACxE,eAAS,IAD+D;AAExE,YAAM;AAFkE,KAA5D,CAAd;AAIA,SAAK,OAAL,GAAe,QAAQ,OAAR,IAAmB,KAAK,OAAvC;AACA,SAAK,MAAL,GAAc,QAAQ,MAAR,IAAkB,KAAK,MAArC;AACA,WAAO,YAAY,WAAZ,CAAwB,OAAxB,EAAiC,WAAW,KAA5C,EAAmD,CAAC,SAAD,EAAY,MAAZ,CAAnD,CAAP;AACD,G;;;;;;;;mBAMD,G,gBAAI,I,EAAK;AACP,QAAI,WAAW,KAAK,gBAAL,CAAsB,KAAtB,CAAf;AACA,WAAO,SAAS,GAAT,CAAa,KAAK,MAAL,GAAc,IAA3B,EAAiC,IAAjC,CAAsC,iBAAS;AACpD,UAAI,KAAJ,EAAW;AACT,eAAO,KAAK,KAAL,CAAW,KAAX,CAAP;AACD;AACF,KAJM,EAIJ,KAJI,CAIE,YAAM,CAAE,CAJV,CAAP;AAKD,G;;;;;;;;;mBAOD,G,gBAAI,I,EAAM,K,EAA8B;AAAA,QAAvB,OAAuB,yDAAb,KAAK,OAAQ;;AACtC,QAAI,MAAM,QAAN,CAAe,IAAf,CAAJ,EAA0B;AACxB,gBAAU,SAAS,OAAnB;AACA,UAAI,MAAM,oBAAY,IAAZ,EAAkB,CAAlB,CAAV;AACA,cAAQ,KAAK,GAAL,CAAR;AACA,aAAO,GAAP;AACD;AACD,QAAI,WAAW,KAAK,gBAAL,CAAsB,KAAtB,CAAf;AACA,WAAO,SAAS,GAAT,CAAa,KAAK,MAAL,GAAc,IAA3B,EAAiC,yBAAe,KAAf,CAAjC,EAAwD,OAAxD,EAAiE,KAAjE,CAAuE,YAAM,CAAE,CAA/E,CAAP;AACD,G;;;;;;;;mBAMD,M,oBAAO,I,EAAK;AACV,QAAI,WAAW,KAAK,gBAAL,CAAsB,QAAtB,CAAf;AACA,WAAO,SAAS,MAAT,CAAgB,KAAK,MAAL,GAAc,IAA9B,EAAoC,KAApC,CAA0C,YAAM,CAAE,CAAlD,CAAP;AACD,G;;;;;;;;;mBAOD,I,iBAAK,O,EAAS,I,EAAc;AAC1B,QAAI,WAAW,KAAK,gBAAL,CAAsB,OAAtB,CAAf;;AAD0B,sCAAL,IAAK;AAAL,UAAK;AAAA;;AAE1B,WAAO,SAAS,IAAT,kBAAc,OAAd,EAAuB,KAAK,MAAL,GAAc,IAArC,SAA8C,IAA9C,EAAP;AACD,G;;;EAvE0B,MAAM,OAAN,CAAc,I","file":"redis.js","sourcesContent":["'use strict';\n\nlet RedisSocket = think.adapter('socket', 'redis');\n\n/**\n * redis cache\n */\nexport default class extends think.adapter.base {\n  /**\n   * init\n   * @param  {Object} options []\n   * @return {}         []\n   */\n  init(options){\n    this.options = think.parseConfig(think.config('cache'), options);\n    this.timeout = this.options.timeout || 0;\n    this.prefix = this.options.prefix || '';\n  }\n  /**\n   * get redis instance\n   * @return {Object} []\n   */\n  getRedisInstance(name){\n    let options = think.parseConfig.call(this.options, think.config('redis'), {\n      command: name,\n      from: 'cache'\n    });\n    this.timeout = options.timeout || this.timeout;\n    this.prefix = options.prefix || this.prefix;\n    return RedisSocket.getInstance(options, thinkCache.REDIS, ['command', 'from']);\n  }\n  /**\n   * get data\n   * @param  {String} name []\n   * @return {Promise}      []\n   */\n  get(name){\n    let instance = this.getRedisInstance('get');\n    return instance.get(this.prefix + name).then(value => {\n      if (value) {\n        return JSON.parse(value);\n      }\n    }).catch(() => {});\n  }\n  /**\n   * set data\n   * @param {String} name    []\n   * @param {Mixed} value   []\n   * @param {Number} timeout []\n   */\n  set(name, value, timeout = this.timeout){\n    if (think.isObject(name)) {\n      timeout = value || timeout;\n      let key = Object.keys(name)[0];\n      value = name[key];\n      name = key;\n    }\n    let instance = this.getRedisInstance('set');\n    return instance.set(this.prefix + name, JSON.stringify(value), timeout).catch(() => {});\n  }\n  /**\n   * delete data\n   * @param  {String} name []\n   * @return {Promise}      []\n   */\n  delete(name){\n    let instance = this.getRedisInstance('delete');\n    return instance.delete(this.prefix + name).catch(() => {});\n  }\n  /**\n   * wrap\n   * @param  {[type]}    name []\n   * @param  {...[type]} data []\n   * @return {[type]}         []\n   */\n  wrap(command, name, ...data){\n    let instance = this.getRedisInstance(command);\n    return instance.wrap(command, this.prefix + name, ...data);\n  }\n}"]}